<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gratia">
<title>Customizing plots • gratia</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Customizing plots">
<meta property="og:description" content="gratia">
<meta property="og:image" content="https://gavinsimpson.github.io/gratia/reference/figures/README-draw-gam-figure-1.png">
<meta property="og:image:alt" content="Plot produced by draw() of 4 smooth functions from a fitted generalized additive model">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@ucfagls">
<meta name="twitter:site" content="@ucfagls">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary" data-bs-theme="dark"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gratia</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0.9002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/gratia.html">Get started</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/custom-plotting.html">Customizing plots</a>
    <a class="dropdown-item" href="../articles/data-slices.html">Data slices</a>
    <a class="dropdown-item" href="../articles/posterior-simulation.html">Posterior Simulation</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/gavinsimpson/gratia/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Customizing plots</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/gavinsimpson/gratia/blob/HEAD/vignettes/custom-plotting.Rmd" class="external-link"><code>vignettes/custom-plotting.Rmd</code></a></small>
      <div class="d-none name"><code>custom-plotting.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>The <code><a href="../reference/draw.html">draw()</a></code> function in {gratia} was envisaged as a
<code>ggplot</code>-based alternative to <code>mgcv:::plot.gam()</code>.
As such, it was never intended to allow the sorts of customization that
is possible with <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code> or some other packages that use
<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code> as the plotting layer. This is largely due to the
decision to produce multiple separate <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code> plots for
GAMs with multiple smooths, which would subsequently be combined into a
single <em>figure</em> on the device, initially using {cowplot} and more
recently {patchwork}. Why I did things this way is evident when you
consider how we might represent smooths of 3 or 4 variables (which are
more common than you might think; consider space-time models via
<code>te(x, y, time, d = c(2,1))</code> or space-depth-time models
[think ocean or atmospheric data over space and at depth (height),
observed over time] via
<code>te(x, y, depth, time, d = c(2, 1, 1))</code>), and which require
facets top produce small multiples, which means we can’t use facets to
plot separate smooths. Additional complications arise when we consider
more complex smooth types, such as splines on the sphere, for which we
might want to us different coordinate systems or geoms to best represent
the underlying smooth.</p>
<p>Having gone down the root of combining multiple <code>ggplot</code>
objects into a single figure, the problem of customizing these plots
quickly rears its head. This vignette presents some solutions to the
problem of modifying or adding to the plots produced by
<code><a href="../reference/draw.html">draw()</a></code> culminating in an example illustrating how to use
{gratia}’s utility functions to produce your own plots from lower-lever
components.</p>
</div>
<div class="section level2">
<h2 id="adding-layers-to-plots-with-the-operator">Adding layers to plots with the <code>&amp;</code> operator<a class="anchor" aria-label="anchor" href="#adding-layers-to-plots-with-the-operator"></a>
</h2>
<p>We start by simulating some data and fitting a GAM with four smooth
functions</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://gavinsimpson.github.io/gratia/">"gratia"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"mgcv"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: nlme</span></span>
<span><span class="co">#&gt; This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org" class="external-link">"dplyr"</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:nlme':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     collapse</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://patchwork.data-imaginist.com" class="external-link">"patchwork"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># simulate data</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">400</span></span>
<span><span class="va">eg1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_sim.html">data_sim</a></span><span class="op">(</span><span class="st">"eg1"</span>, n <span class="op">=</span> <span class="va">n</span>, seed <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit model</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">eg1</span>, method <span class="op">=</span> <span class="st">"REML"</span><span class="op">)</span></span></code></pre></div>
<p>The default plot produced by <code><a href="../reference/draw.html">draw()</a></code> is</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/draw.html">draw</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/draw-eg1--1.png" width="700"></p>
<p>If we want to change the theme for the plots, we can’t append a
<code><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme()</a></code> layer to <code>p</code> as this only affects the
last plot in the <em>patchwork</em><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;A &lt;em&gt;patchwork&lt;/em&gt; is the name given to the
composition of individual plots created by
&lt;code&gt;&lt;a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link"&gt;patchwork::wrap_plots()&lt;/a&gt;&lt;/code&gt; or the composition operators
&lt;code&gt;+&lt;/code&gt;, &lt;code&gt;|&lt;/code&gt; and &lt;code&gt;/&lt;/code&gt;.&lt;/p&gt;'><sup>1</sup></a></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/draw-eg1-wrong-theme-1.png" width="700"></p>
<p>One way to apply the theme to all plots in the patchwork is to the
the <code>&amp;</code> operator.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&amp;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/draw-eg1-right-theme-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="combining-individual-plots-produced-by-draw">Combining individual plots produced by <code>draw()</code><a class="anchor" aria-label="anchor" href="#combining-individual-plots-produced-by-draw"></a>
</h2>
<p><code><a href="../reference/draw.html">draw()</a></code> methods like <code><a href="../reference/draw.gam.html">draw.gam()</a></code> return an
object created by <code><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">patchwork::wrap_plots()</a></code>, and as a result
it isn’t straightforward to combine those objects into a new
patchwork</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/draw.html">draw</a></span><span class="op">(</span><span class="va">m</span>, select <span class="op">=</span> <span class="st">"s(x0)"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/draw.html">draw</a></span><span class="op">(</span><span class="va">m</span>, select <span class="op">=</span> <span class="st">"s(x1)"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/draw.html">draw</a></span><span class="op">(</span><span class="va">m</span>, select <span class="op">=</span> <span class="st">"s(x2)"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `wrap_dims()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> Need 3 panels, but together `nrow` and `ncol` only provide 1.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please increase `ncol` and/or `nrow`.</span></span></code></pre></div>
<p>To avoid the error, we need to use
<code><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">patchwork::plot_layout()</a></code> to set the dimensions we want</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span> <span class="va">p3</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/draw-multiple-patchworks-layout-1.png" width="700"></p>
<p>The above could have been achieved directly via
<code><a href="../reference/draw.html">draw()</a></code></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/draw.html">draw</a></span><span class="op">(</span><span class="va">m</span>, select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"s(x0)"</span>, <span class="st">"s(x1)"</span>, <span class="st">"s(x2)"</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/draw-multiple-patchworks-draw-1.png" width="700"></p>
<p>but it is instructive to know how to combine the outputs of
<code><a href="../reference/draw.html">draw()</a></code> should the need arise, such as when you want to
create a patchwork of plots from different models.</p>
</div>
<div class="section level2">
<h2 id="building-your-own-plot-by-hand">Building your own plot by hand<a class="anchor" aria-label="anchor" href="#building-your-own-plot-by-hand"></a>
</h2>
<p>{gratia} provides high-level functions like <code><a href="../reference/draw.html">draw()</a></code> to
get you a good graphical overview of a fitted model, but with little
option for customisation — it isn’t possible or desirable to allow all
possible customisation options and fatures of {ggplot2} through a single
function. Think about how many arguments that would require!</p>
<p>Instead, {gratia} also exports the lower-level functions used
<code><a href="../reference/draw.html">draw()</a></code> so that you can create your own plot using whatever
{ggplot2} functions make sense. In the next few code blocks we’ll see
how the plot created by <code>draw(m)</code> can be recreated by hand
using these lower-level building blocks.</p>
<p>The main thing we need is to evaluate the smooths at values of their
covariates. This is done using <code><a href="../reference/smooth_estimates.html">smooth_estimates()</a></code>. We also
need to add a credible interval to the evaluations, which can be done
<em>tidyverse</em>-style via <code><a href="../reference/add_confint.html">add_confint()</a></code></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># evaluate the smooths</span></span>
<span><span class="va">sm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_estimates.html">smooth_estimates</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_confint.html">add_confint</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sm</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 400 × 11</span></span></span>
<span><span class="co">#&gt;    .smooth .type .by   .estimate   .se     x0    x1    x2    x3 .lower_ci</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.929</span> 0.422 0.013<span style="text-decoration: underline;">1</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.76</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.881</span> 0.396 0.023<span style="text-decoration: underline;">0</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.66</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.834</span> 0.372 0.032<span style="text-decoration: underline;">9</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.56</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.786</span> 0.348 0.042<span style="text-decoration: underline;">9</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.47</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.738</span> 0.326 0.052<span style="text-decoration: underline;">8</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.38</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.690</span> 0.305 0.062<span style="text-decoration: underline;">7</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.29</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.643</span> 0.287 0.072<span style="text-decoration: underline;">7</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.20</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.595</span> 0.270 0.082<span style="text-decoration: underline;">6</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.12</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.548</span> 0.255 0.092<span style="text-decoration: underline;">5</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">1.05</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> s(x0)   TPRS  <span style="color: #BB0000;">NA</span>       -<span style="color: #BB0000;">0.501</span> 0.242 0.102     <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span>    -<span style="color: #BB0000;">0.975</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 390 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: .upper_ci &lt;dbl&gt;</span></span></span></code></pre></div>
<p>By default <code><a href="../reference/draw.gam.html">draw.gam()</a></code> will add partial residuals to the
partial effects plots. To achieve the same effect, we need to add the
partial residuals to the data used to fit the model. This can be done
via <code><a href="../reference/add_partial_residuals.html">add_partial_residuals()</a></code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add partial residuals to data</span></span>
<span><span class="va">eg1</span> <span class="op">&lt;-</span> <span class="va">eg1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_partial_residuals.html">add_partial_residuals</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div>
<p>This will<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;currently; I’m not entirely happy with this naming
convention as there’s nothing to indicate to the user that these are
&lt;em&gt;partial residuals&lt;/em&gt; for the smooth with name matching the created
variable name.&lt;/p&gt;"><sup>2</sup></a> add columns with names
<code>"s(x0)"</code>. <code>"s(x1)"</code>, etc. to the data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">eg1</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "y"     "x0"    "x1"    "x2"    "x3"    "f"     "f0"    "f1"    "f2"   </span></span>
<span><span class="co">#&gt; [10] "f3"    "s(x0)" "s(x1)" "s(x2)" "s(x3)"</span></span></code></pre></div>
<p>Now we have everything we need to recreate the plots created by
<code><a href="../reference/draw.gam.html">draw.gam()</a></code>. In the code block below we filter
<code>sm</code> to focus on a specific smooth, here <span class="math inline">\(f(x2)\)</span> (<code>"s(x2)"</code>), then we
add</p>
<ol style="list-style-type: decimal">
<li>a rug plot of the observed values of <code>x2</code>,</li>
<li>the credible interval around the estimated smooth,</li>
<li>the partial residuals as a point layer,</li>
<li>the estimated smooth as a line layer,</li>
<li>some annotation</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_sx2</span> <span class="op">&lt;-</span> <span class="va">sm</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.smooth</span> <span class="op">==</span> <span class="st">"s(x2)"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html" class="external-link">geom_rug</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x2</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">eg1</span>,</span>
<span>    sides <span class="op">=</span> <span class="st">"b"</span>, length <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="st">"npc"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.lower_ci</span>, ymax <span class="op">=</span> <span class="va">.upper_ci</span>, x <span class="op">=</span> <span class="va">x2</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x2</span>, y <span class="op">=</span> <span class="va">`s(x2)`</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">eg1</span>, cex <span class="op">=</span> <span class="fl">1.5</span>, colour <span class="op">=</span> <span class="st">"steelblue3"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x2</span>, y <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Partial effect"</span>, title <span class="op">=</span> <span class="st">"s(x2)"</span><span class="op">)</span></span>
<span><span class="va">p_sx2</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/custom-plot-sx2-1.png" width="700"></p>
<p>Assuming we repeat the above steps for the other smooths, creating
plot objects <code>p_sx0</code>, <code>p_sx1</code>, <code>p_sx2</code>,
and <code>p_sx3</code> (code not shown), we can complete the plot by
creating the patchwork with the desired number of rows and columns</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_sx0</span> <span class="op">+</span> <span class="va">p_sx1</span> <span class="op">+</span> <span class="va">p_sx2</span> <span class="op">+</span> <span class="va">p_sx3</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/custom-plot-final-1.png" width="700"></p>
<p>The real benefit of having complete control over how the data are
plotted is that you can use the power of {ggplot2} to map additional
variables to plot aesthetics. As an example, let’s assume we have a
factor variable in the original data and we want to colour the partial
residuals according to the levels of this factor. Let’s create that
factor</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">eg1</span> <span class="op">&lt;-</span> <span class="va">eg1</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>fac <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now we can modify our plotting code to map <code>fac</code> to the
colour aesthetic when we plot the partial residuals. To save some
typing, we’ll reorder the layers in the plot and add the partial
residuals last</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plt</span> <span class="op">&lt;-</span> <span class="va">sm</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">.smooth</span> <span class="op">==</span> <span class="st">"s(x2)"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html" class="external-link">geom_rug</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x2</span><span class="op">)</span>,</span>
<span>    data <span class="op">=</span> <span class="va">eg1</span>,</span>
<span>    sides <span class="op">=</span> <span class="st">"b"</span>, length <span class="op">=</span> <span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="st">"npc"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.lower_ci</span>, ymax <span class="op">=</span> <span class="va">.upper_ci</span>, x <span class="op">=</span> <span class="va">x2</span><span class="op">)</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x2</span>, y <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Partial effect"</span>, title <span class="op">=</span> <span class="st">"s(x2)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x2</span>, y <span class="op">=</span> <span class="va">`s(x2)`</span>,</span>
<span>      colour <span class="op">=</span> <span class="va">fac</span></span>
<span>    <span class="op">)</span>, <span class="co"># &lt;-- map fac to colour aesthetic</span></span>
<span>    data <span class="op">=</span> <span class="va">eg1</span>, cex <span class="op">=</span> <span class="fl">1.5</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/plot-partial-resids-with-colours-by-fac-1.png" width="700"></p>
<p>We can also do some simple model checking by plotting the smooth with
partial residuals coloured according to one of the other covariates (we
could also do this by plotting the actual residuals against covariates).
In the code chunk below, we map the covariate <code>x1</code> to both
the <em>colour</em> and <em>size</em> aesthetics (note we deleted
<code>cex = 1.5</code> to allow the mapping to <em>size</em>)</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plt</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="va">x2</span>, y <span class="op">=</span> <span class="va">`s(x2)`</span>,</span>
<span>      colour <span class="op">=</span> <span class="va">x1</span>, size <span class="op">=</span> <span class="va">x1</span></span>
<span>    <span class="op">)</span>, <span class="co"># &lt;-- map fac to colour aesthetic</span></span>
<span>    data <span class="op">=</span> <span class="va">eg1</span>, alpha <span class="op">=</span> <span class="fl">0.3</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> <span class="co"># &lt;-- deleted cex!!</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_colour_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span></span></code></pre></div>
<p><img src="custom-plotting_files/figure-html/plot-partial-resids-with-colours-by-x1-1.png" width="700"></p>
<p>The resulting plot doesn’t show any particular problems with the
model because of the way the data were simulated, but hopefully this
illustrates what can be possible once you use the low-level functions
provided by {gratia}.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://fromthebottomoftheheap.net" class="external-link">Gavin L. Simpson</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
