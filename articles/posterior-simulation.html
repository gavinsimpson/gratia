<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Posterior Simulation â€¢ gratia</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Posterior Simulation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gratia</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.2.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/gratia.html">Get started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/custom-plotting.html">Customizing plots</a></li>
    <li><a class="dropdown-item" href="../articles/data-slices.html">Data slices</a></li>
    <li><a class="dropdown-item" href="../articles/posterior-simulation.html">Posterior Simulation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gavinsimpson/gratia/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Posterior Simulation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/gavinsimpson/gratia/blob/main/vignettes/articles/posterior-simulation.Rmd" class="external-link"><code>vignettes/articles/posterior-simulation.Rmd</code></a></small>
      <div class="d-none name"><code>posterior-simulation.Rmd</code></div>
    </div>

    
    
<p><introduction></introduction></p>
<p>This vignette describes {gratia}â€™s tools for posterior simulation, a
powerful way of doing inference using estimated generalized additive
models.</p>
<p>Weâ€™ll need the following packages for this vignette:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"mgcv"</span>, <span class="st">"gratia"</span>, <span class="st">"dplyr"</span>, <span class="st">"tidyr"</span>, <span class="st">"ggplot2"</span>, <span class="st">"ggdist"</span>,</span>
<span>  <span class="st">"distributional"</span>, <span class="st">"tibble"</span>, <span class="st">"withr"</span>, <span class="st">"patchwork"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">pkgs</span>, <span class="va">library</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span>, logical.return <span class="op">=</span> <span class="cn">TRUE</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: nlme</span></span>
<span><span class="co">#&gt; This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:nlme':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     collapse</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="co">#&gt;           mgcv         gratia          dplyr          tidyr        ggplot2 </span></span>
<span><span class="co">#&gt;           TRUE           TRUE           TRUE           TRUE           TRUE </span></span>
<span><span class="co">#&gt;         ggdist distributional         tibble          withr      patchwork </span></span>
<span><span class="co">#&gt;           TRUE           TRUE           TRUE           TRUE           TRUE</span></span></code></pre></div>
<p>A generalized additive model (GAM) has the following form</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Î¼</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>Î·</mi><mi>i</mi></msub><mo>=</mo><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><msub><mi>ğ—</mi><mi>i</mi></msub><mi>ğ›„</mi><mo>+</mo><munderover><mo>âˆ‘</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>J</mi></munderover><msub><mi>f</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="0.278em"></mspace><msub><mi>y</mi><mi>i</mi></msub><mo>âˆ¼</mo><mtext mathvariant="normal">EF</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Î¼</mi><mi>i</mi></msub><mo>,</mo><mi>Ï•</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
g(\mu_i) = \eta_i = A_i + \mathbf{X}_i \boldsymbol{\gamma} + \sum_{j=1}^{J} f_j(x_{ij}), \; y_i \sim \text{EF}(\mu_i, \phi)
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">g()</annotation></semantics></math>
is the link function,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
is an offset,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ğ—</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\mathbf{X}_i</annotation></semantics></math>
is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th
row of a parametric model matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›„</mi><annotation encoding="application/x-tex">\boldsymbol{\gamma}</annotation></semantics></math>
is a vector of parameters for the parametric terms,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>j</mi></msub><annotation encoding="application/x-tex">f_j</annotation></semantics></math>
is a smooth function of covariate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>j</mi></msub><annotation encoding="application/x-tex">x_j</annotation></semantics></math>.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>âˆ¼</mo><mtext mathvariant="normal">EF</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Î¼</mi><mi>i</mi></msub><mo>,</mo><mi>Ï•</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">y_i \sim \text{EF}(\mu_i, \phi)</annotation></semantics></math>
denotes that the observations
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">y_i</annotation></semantics></math>
are distributed as some member of the exponential family of
distributions with mean
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Î¼</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\mu_i</annotation></semantics></math>
and scale parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Ï•</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>.</p>
<p>The smooth functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>j</mi></msub><annotation encoding="application/x-tex">f_j</annotation></semantics></math>
are represented in the model via penalised splines basis expansions of
the covariates, that are a weighted sum of basis functions</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>j</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><munderover><mo>âˆ‘</mo><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mi>Î²</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub><msub><mi>b</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
f_j(x_{ij}) = \sum_{k=1}^{K} \beta_{jk} b_{jk}(x_{ij})
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Î²</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub><annotation encoding="application/x-tex">\beta_{jk}</annotation></semantics></math>
is the weight (coefficient) associated with the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>th
basis function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>b</mi><mrow><mi>j</mi><mi>k</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">b_{jk}()</annotation></semantics></math>
evaluated at the covariate value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">x_{ij}</annotation></semantics></math>
for the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>th
smooth function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>j</mi></msub><annotation encoding="application/x-tex">f_j</annotation></semantics></math>.
Wiggliness penalties
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>âˆ‘</mo><mi>j</mi></msub><msub><mi>Î»</mi><mi>j</mi></msub><msup><mi>ğ›ƒ</mi><mi>ğ–³</mi></msup><msub><mi>ğ’</mi><mi>j</mi></msub><mi>ğ›ƒ</mi></mrow><annotation encoding="application/x-tex">\sum_j \lambda_j \boldsymbol{\beta}^{\mathsf{T}} \mathbf{S}_j \boldsymbol{\beta}</annotation></semantics></math>
controls the degree of smoothing applied to the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>j</mi></msub><annotation encoding="application/x-tex">f_j</annotation></semantics></math>
through the smoothing parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Î»</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\lambda_j</annotation></semantics></math>.</p>
<p>Having fitted the GAM in mgcv using REML or ML smoothness selection
we obtain a vector of coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›ƒ</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\boldsymbol{\beta}}</annotation></semantics></math>
(which also includes the coefficients for the parametric terms, , for
convenience). The estimates of these coefficients are conditional upon
the data and the selected values of the smoothing parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Î»</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\lambda_j</annotation></semantics></math>.
Using the Bayesian view of smoothing via REML smoothness selection,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›ƒ</mi><annotation encoding="application/x-tex">\boldsymbol{\beta}</annotation></semantics></math>
has a multivariate normal posterior distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ›ƒ</mi><mo stretchy="false" form="prefix">|</mo><mi>ğ›ˆ</mi><mo>,</mo><mi>ğ›Œ</mi><mo>âˆ¼</mo><mtext mathvariant="normal">MVN</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>ğ›ƒ</mi><mo accent="true">Ì‚</mo></mover><mo>,</mo><msub><mi>ğ•</mi><mtext mathvariant="normal">b</mtext></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{\beta} | \boldsymbol{\eta}, \boldsymbol{\lambda} \sim \text{MVN}(\hat{\boldsymbol{\beta}}, \mathbf{V}_{\text{b}})</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ğ•</mi><mtext mathvariant="normal">b</mtext></msub><annotation encoding="application/x-tex">\mathbf{V}_{\text{b}}</annotation></semantics></math>
is the Bayesian covariance matrix of the estimated parameters, (the
subscript
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtext mathvariant="normal">b</mtext><annotation encoding="application/x-tex">\text{b}</annotation></semantics></math>
is used to differentiate this Bayesian covariance matrix from the
frequentist version which is also available in the mgcv model
output).</p>
<div class="section level2">
<h2 id="what-are-we-simulating">What are we simulating?<a class="anchor" aria-label="anchor" href="#what-are-we-simulating"></a>
</h2>
<p>Posterior simulation involves randomly sampling from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">MVN</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>ğ›ƒ</mi><mo accent="true">Ì‚</mo></mover><mo>,</mo><msub><mi>ğ•</mi><mtext mathvariant="normal">b</mtext></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{MVN}(\hat{\boldsymbol{\beta}}, \mathbf{V}_{\text{b}})</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="normal">EF</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Î¼</mi><mi>i</mi></msub><mo>,</mo><mi>Ï•</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{EF}(\mu_i, \phi)</annotation></semantics></math>,
or both.</p>
<p>We might simulate from the posterior distribution of a single
estimated smooth function to see the uncertainty in the estimate of that
function. To do this we simulate for just a subset of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Î²</mi><mrow><mi>j</mi><mo>â‹…</mo></mrow></msub><annotation encoding="application/x-tex">\beta_{j \cdot}</annotation></semantics></math>
associated with the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mi>j</mi></msub><annotation encoding="application/x-tex">f_j</annotation></semantics></math>
of interest. Instead, we might be interested in the uncertainty in the
expectation (expected value) of the model at some given values of the
covariates, in which case we can simulate for all
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›ƒ</mi><annotation encoding="application/x-tex">\boldsymbol{\beta}</annotation></semantics></math>
to sample from the posterior of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ”¼</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbb{E}(y_i)</annotation></semantics></math>,
the fitted values of the model. Or we might want to generate new values
of response variable via draws from the conditional distribution of the
response, by simulating new response data
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ğ•ª</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\mathbb{y}^{\ast}</annotation></semantics></math>,
at either the observed
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ±</mi><annotation encoding="application/x-tex">\mathbf{x}</annotation></semantics></math>
or new values $^{}, from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>y</mi><mi>i</mi><mo>*</mo></msubsup><mo stretchy="false" form="prefix">|</mo><mi>ğ›ˆ</mi><mo>,</mo><mi>ğ±</mi><mo>âˆ¼</mo><mtext mathvariant="normal">EF</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mover><msub><mi>Î¼</mi><mi>i</mi></msub><mo accent="true">Ì‚</mo></mover><mo>,</mo><mi>Ï•</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">y^{\ast}_i | \boldsymbol{\eta}, \mathbf{x} \sim \text{EF}(\hat{\mu_i}, \phi)</annotation></semantics></math>.
Finally, we can combine posterior simulation from both distributions to
generate posterior draws for new data
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>ğ•ª</mi><mo>*</mo></msup><annotation encoding="application/x-tex">\mathbb{y}^{\ast}</annotation></semantics></math>
that also include the uncertainty in the expected values.</p>
<p>gratia has functionality for all these options through the following
functions</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="../reference/smooth_samples.html">smooth_samples()</a></code> generates draws from the posterior
distribution of single estimated smooth functions,</li>
<li>
<code><a href="../reference/fitted_samples.html">fitted_samples()</a></code> generates draws from the posterior
distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ”¼</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false" form="prefix">|</mo><msub><mi>ğ—</mi><mi>i</mi></msub><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbb{E}(y_i | \mathbf{X}_i = x_i)</annotation></semantics></math>,
the expected value of the responss,</li>
<li>
<code><a href="../reference/predicted_samples.html">predicted_samples()</a></code>, generates new response data given
supplied values of covariates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>y</mi><mi>i</mi><mo>*</mo></msubsup><mo stretchy="false" form="prefix">|</mo><msub><mi>ğ—</mi><mi>i</mi></msub><mo>=</mo><msubsup><mi>x</mi><mi>i</mi><mo>*</mo></msubsup></mrow><annotation encoding="application/x-tex">y^{\ast}_i | \mathbf{X}_i = x^{\ast}_i</annotation></semantics></math>
</li>
<li>
<code><a href="../reference/posterior_samples.html">posterior_samples()</a></code>, generates draws from the posterior
distribution of the model, including the uncertainty in the estimated
parameters of that model.</li>
</ol>
<p>In simpler terms, <code><a href="../reference/fitted_samples.html">fitted_samples()</a></code> generates predictions
about the â€œaverageâ€ or expected value of the response at values of the
covariates. These predictions only include the uncertainty in the
estimated values of the model coefficients. In contrast,
<code><a href="../reference/posterior_samples.html">posterior_samples()</a></code> generates predictions of the actual
values of the response we might expect to observe (if the model is
correct) given values of the covariates. These predicted values include
the variance of the sampling distribution (error term).
<code><a href="../reference/predicted_samples.html">predicted_samples()</a></code> lies somewhere in between these two;
the predicted values only include the variation in the sampling
distribution, and take the model as fixed, known.</p>
<p>It is worth reminding ourselves that these posterior draws are all
conditional upon the selected values of the smoothing parameter(s)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Î»</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\lambda_j</annotation></semantics></math>.
We act as if the wiggliness of the estimated smooths was known, when in
actual fact we estimated (selected is perhaps a better description)
these wiglinesses from the data during model fitting. If the estimated
GAM has been fitted with <code>method</code> argument
<code>"REML"</code>, or <code>"ML"</code>, then a version of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ğ•</mi><mtext mathvariant="normal">b</mtext></msub><annotation encoding="application/x-tex">\mathbf{V}_{\text{b}}</annotation></semantics></math>
that is corrected for having selected smoothing parameters,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ğ•</mi><mtext mathvariant="normal">c</mtext></msub><annotation encoding="application/x-tex">\mathbf{V}_{\text{c}}</annotation></semantics></math>,
is generally available. This allows, to an extent, for posterior
simulation to account for the additional source of uncertainty of having
chosen then values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ›Œ</mi><annotation encoding="application/x-tex">\boldsymbol{\lambda}</annotation></semantics></math>.</p>
<p>There are two additional functions available in gratia that do
posterior simulation:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code>, and</li>
<li>
<code><a href="../reference/derivative_samples.html">derivative_samples()</a></code>.</li>
</ul>
<p>gratia provides <code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code> methods for models estimated
using <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/bam.html" class="external-link">bam()</a></code>, and <code><a href="https://rdrr.io/pkg/mgcv/man/gamm.html" class="external-link">gamm()</a></code>,
as well as those fitted via <code>scam()</code> in the scam package.
<code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code> is a base R convention that does the same thing
as <code><a href="../reference/predicted_samples.html">predicted_samples()</a></code>, just in a non-tidy way (that is not
pejorative; it returns the simulated response values as a matrix, which
is arguably more useful if you are doing math or further statistical
computation.) <code><a href="../reference/derivative_samples.html">derivative_samples()</a></code> provides draws from the
posterior distribution of the derivative of response variable for a
small change in a focal covariate value.
<code><a href="../reference/derivative_samples.html">derivative_samples()</a></code> is a less general version of
<code><a href="../reference/fitted_samples.html">fitted_samples()</a></code>; you could achieve the same thing by two
separate calls to <code><a href="../reference/fitted_samples.html">fitted_samples()</a></code>. Weâ€™ll reserve
discussion of <code><a href="../reference/derivative_samples.html">derivative_samples()</a></code> to a separate vignette
focused on estimating derivatives from GAMs.</p>
<p>In the following sections weâ€™ll look at each of the four main
posterior simulation functions in turn.</p>
</div>
<div class="section level2">
<h2 id="posterior-smooths-and-smooth_samples">Posterior smooths and <code>smooth_samples()</code><a class="anchor" aria-label="anchor" href="#posterior-smooths-and-smooth_samples"></a>
</h2>
<p>We can sample from the posterior distribution of the coefficients of
a particular smooth
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>Î²</mi><mo accent="true">Ì‚</mo></mover><mi>j</mi></msub><annotation encoding="application/x-tex">\hat{\beta}_j</annotation></semantics></math>
given the values of the smoothing parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>ğ›Œ</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\boldsymbol{\lambda}}</annotation></semantics></math>.
We generate posterior samples of smooths by sampling
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ğ›ƒ</mi><mrow><mi>j</mi><mo>â‹†</mo></mrow></msub><mo>âˆ¼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>Î²</mi><mo accent="true">Ì‚</mo></mover><mi>j</mi></msub><mo>,</mo><msub><mi>ğ•</mi><msub><mover><mi>Î²</mi><mo accent="true">Ì‚</mo></mover><mi>j</mi></msub></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{\beta}_{j\star} \sim N(\hat{\beta}_j, \mathbf{V}_{\hat{\beta}_j})</annotation></semantics></math>
and forming
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ğ—</mi><msub><mover><mi>ğ›ƒ</mi><mo accent="true">Ì‚</mo></mover><mi>j</mi></msub></msub><msubsup><mi>ğ›ƒ</mi><mrow><mi>j</mi><mo>â‹†</mo></mrow><mi>ğ–³</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{X}_{\hat{\boldsymbol{\beta}}_j} \boldsymbol{\beta}_{j\star}^{\mathsf{T}}</annotation></semantics></math>.
This sampling can be done using <code><a href="../reference/smooth_samples.html">smooth_samples()</a></code>.</p>
<p>To illustrate this, weâ€™ll simulate data from Gu &amp; Wabhaâ€™s 4
smooth example, and fit a GAM to the simulated data</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_sim.html">data_sim</a></span><span class="op">(</span><span class="st">"eg1"</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">m_ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">ss_df</span>, method <span class="op">=</span> <span class="st">"REML"</span><span class="op">)</span></span></code></pre></div>
<p>When we are simulating from the posterior distribution of an
estimated smooth, we are only sampling from the coefficients of the
particular smooth. In this model, the coefficients for the smooth
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(x_0)</annotation></semantics></math>
are stored as elements 2 through 10 of the coefficients vector.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s_x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_smooth.html">get_smooth</a></span><span class="op">(</span><span class="va">m_ss</span>, <span class="st">"s(x0)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/smooth_coef_indices.html">smooth_coef_indices</a></span><span class="op">(</span><span class="va">s_x0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  2  3  4  5  6  7  8  9 10</span></span></code></pre></div>
<p>To sample from the posterior distribution of these coefficients we
use <code><a href="../reference/smooth_samples.html">smooth_samples()</a></code> choosing the particular smooth weâ€™re
interested in using the <code>select</code> argument; if we want to
sample smooths from the posteriors of all smooths in a model, then
<code>select</code> can be left at its default value.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sm_samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_samples.html">smooth_samples</a></span><span class="op">(</span><span class="va">m_ss</span>, select <span class="op">=</span> <span class="st">"s(x0)"</span>, n_vals <span class="op">=</span> <span class="fl">100</span>, n <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">21</span><span class="op">)</span></span></code></pre></div>
<p>Typically weâ€™re not too bothered about the particular values of the
covariate at which we evaluate the posterior smooths; below we ask for
100 evenly spaced values of <code>x0</code> using <code>n_vals</code>,
but you can provide the covariates values yourself via the
<code>data</code> argument. The number of posterior smooths sampled is
controlled by argument <code>n</code>; here we ask for 100 samples.</p>
<p>Objects returned by <code><a href="../reference/smooth_samples.html">smooth_samples()</a></code> have a
<code><a href="../reference/draw.html">draw()</a></code> method available for them</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sm_samp</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/draw.html">draw</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/draw-smooth-samples-x0-1.png" width="700">
To only draw some of the posterior smooths you can set
<code>n_samples</code> which will randomly select that many smooths to
draw (a seed can be provided via argument <code>seed</code> to make the
set of chosen smooths repeatable.)</p>
<p>The credible interval of a smooth will contain most of these smooths.
For the standard 95% credible interval, only some of the sampled smooths
will exceed the limits of the interval.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># evaluate the fitted smooth over x0 and add on a credible interval</span></span>
<span><span class="va">sm_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_estimates.html">smooth_estimates</a></span><span class="op">(</span><span class="va">m_ss</span>, select <span class="op">=</span> <span class="st">"s(x0)"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_confint.html">add_confint</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># plot the smooth, credible interval, and posterior smooths</span></span>
<span><span class="va">sm_est</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_lineribbon</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.lower_ci</span>, ymax <span class="op">=</span> <span class="va">.upper_ci</span><span class="op">)</span>,</span>
<span>    orientation <span class="op">=</span> <span class="st">"vertical"</span>, fill <span class="op">=</span> <span class="st">"#56B4E9"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">sm_samp</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.value</span>, group <span class="op">=</span> <span class="va">.draw</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1</span>, colour <span class="op">=</span> <span class="st">"#E69F00"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="../reference/smooth_label.html">smooth_label</a></span><span class="op">(</span><span class="va">s_x0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/plot-smooth-ci-and-posterior-smooths-1.png" width="700"></p>
<p>Following <span class="citation">Marra &amp; Wood (2012)</span>, the
blue credible interval will contain on average 95% of the grey lines
(posterior smooths) at any given value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mn>0</mn></msub><annotation encoding="application/x-tex">x_0</annotation></semantics></math>.
This <em>across the function</em> frequentist interpretation of the
credible interval implies that for some values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mn>0</mn></msub><annotation encoding="application/x-tex">x_0</annotation></semantics></math>
the coverage will be less than 95% and for other values greater than
95%.</p>
</div>
<div class="section level2">
<h2 id="posterior-fitted-values-via-fitted_samples">Posterior fitted values via <code>fitted_samples()</code><a class="anchor" aria-label="anchor" href="#posterior-fitted-values-via-fitted_samples"></a>
</h2>
<p>Posterior fitted values are draws from the posterior distribution of
the mean or expected value of the response. These expectations are what
is returned when you use <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> on an estimated GAM,
except <code><a href="../reference/fitted_samples.html">fitted_samples()</a></code> includes the uncertainty in the
estimated model coefficients, whereas <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> just uses
the estimated coefficients.</p>
<p>In this example, using <code><a href="../reference/data_sim.html">data_sim()</a></code> we simulate data from
example 6 of <span class="citation">Luo &amp; Wahba (1997)</span></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>sin</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>â‹…</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>4</mn><mi>x</mi><mo>âˆ’</mo><mn>2</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mn>2</mn><mo>â‹…</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>âˆ’</mo><mn>256</mn><mo>â‹…</mo><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>x</mi><mo>âˆ’</mo><mn>0.5</mn><mo stretchy="true" form="postfix">)</mo></mrow><mn>2</mn></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\sin(2 \cdot (4x - 2)) + 2 \cdot \exp(-256 \cdot (x - 0.5)^2)
</annotation></semantics></math></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Trig.html" class="external-link">sin</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="op">(</span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">256</span> <span class="op">*</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_sim.html">data_sim</a></span><span class="op">(</span><span class="st">"lwf6"</span>, dist <span class="op">=</span> <span class="st">"normal"</span>, scale <span class="op">=</span> <span class="fl">0.3</span>, seed <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">plt</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">f</span><span class="op">)</span></span>
<span><span class="va">plt</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/luo-wabha-function-sim-plot-1.png" width="700"></p>
<p>To these data we fit an adaptive smoother</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">25</span>, bs <span class="op">=</span> <span class="st">"ad"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df</span>, method <span class="op">=</span> <span class="st">"REML"</span><span class="op">)</span></span></code></pre></div>
<p>Next we create a data slice of 200 values over the interval (0,1) at
which weâ€™ll predict from the model and generate posterior fitted values
for</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_slice.html">data_slice</a></span><span class="op">(</span><span class="va">m</span>, x <span class="op">=</span> <span class="fu"><a href="../reference/evenly.html">evenly</a></span><span class="op">(</span><span class="va">x</span>, lower <span class="op">=</span> <span class="fl">0</span>, upper <span class="op">=</span> <span class="fl">1</span>, n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>.row <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>then we compute the fitted values for the new data</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitted_values.html">fitted_values</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">new_df</span><span class="op">)</span></span></code></pre></div>
<p>The posterior fitted values are drawn with
<code><a href="../reference/fitted_samples.html">fitted_samples()</a></code> using a Gaussian approximation to the
posterior. Here we just take 10 draws from the posterior for each
observation in <code>new_df</code> and merge the posterior draws with
the data</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitted_samples.html">fitted_samples</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">new_df</span>, n <span class="op">=</span> <span class="fl">10</span>, seed <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">new_df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">.row</span>, <span class="va">x</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.row</span> <span class="op">==</span> <span class="va">.row</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Adding the posterior fitted samples to the plot of the data,
superimposing the Bayesian credible interval on the fitted values</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plt</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fv</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.fitted</span>, ymin <span class="op">=</span> <span class="va">.lower_ci</span>, ymax <span class="op">=</span> <span class="va">.upper_ci</span><span class="op">)</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"red"</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">fs</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">.draw</span>, x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">.fitted</span><span class="op">)</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"yellow"</span>, alpha <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/luo-wabha-plot-samples-1.png" width="700"></p>
<p>we see the posterior draws are largely contained the credible
interval.</p>
<p>The difference between what we did here and what we did with
<code><a href="../reference/smooth_samples.html">smooth_samples()</a></code> is that now weâ€™re including the effects of
all the other model terms. In this simple model with a single smooth and
an identity link, the only difference is that the model constant term
and its uncertainty is included in the samples.</p>
</div>
<div class="section level2">
<h2 id="additional-examples">Additional examples<a class="anchor" aria-label="anchor" href="#additional-examples"></a>
</h2>
<div class="section level3">
<h3 id="prediction-intervals">Prediction intervals<a class="anchor" aria-label="anchor" href="#prediction-intervals"></a>
</h3>
<p>One use for posterior simulation is to generate <em>prediction</em>
intervals for a fitted model. Prediction intervals include two sources
of uncertainty; that from the estimated model itself, plus the sampling
uncertainty or error that arises from drawing observations from the
conditional distribution of the response.</p>
<p>For example, in a Gaussian GAM, the first source of uncertainty comes
from the uncertainty in the estimates of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Î²</mi><mi>j</mi></msub><annotation encoding="application/x-tex">\beta_j</annotation></semantics></math>,
the model coefficients. This uncertainty is in the mean or expected
value of the response. The second source of uncertainty stems from the
error term, the estimated variance of the response. These two parameters
define the conditional distribution of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mi>i</mi></msub><annotation encoding="application/x-tex">Y_i</annotation></semantics></math>.
For any value of the covariate(s)
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ğ—</mi><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math>,
our estimated model defines the entire distribution of the response
values we might expect to observe at those covariate values.</p>
<p>To illustrate, weâ€™ll fit a simple GAM with a single smooth function
to data simulate from Gu &amp; Wabhaâ€™s function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mn>2</mn></msub><annotation encoding="application/x-tex">f_2</annotation></semantics></math>
using <code><a href="../reference/data_sim.html">data_sim()</a></code>. We simulate 400 values from a Gaussian
distribution with variance
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Ïƒ</mi><mn>2</mn></msup><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sigma^2 = 1</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_sim.html">data_sim</a></span><span class="op">(</span><span class="st">"gwf2"</span>, n <span class="op">=</span> <span class="fl">400</span>, scale <span class="op">=</span> <span class="fl">1</span>, dist <span class="op">=</span> <span class="st">"normal"</span>, seed <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>The simulated data, and the true function from which they were
generated are shown below</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">gw_f2</span>, colour <span class="op">=</span> <span class="st">"#0072B2"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/simulated-data-gaussian-gam-1.png" width="700"></p>
<p>A GAM for these data contains a single smooth function of
<code>x</code></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df</span>, method <span class="op">=</span> <span class="st">"REML"</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If we consider a new value of the covariate <code>x</code>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo>*</mo></msup><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">x^{\ast} = 0.5</annotation></semantics></math>,
the expected value of the response given our model,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ğ”¼</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mi>y</mi><mo>*</mo></msup><mo stretchy="false" form="prefix">|</mo><mi>x</mi><mo>=</mo><msup><mi>x</mi><mo>*</mo></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbb{E}(y^{*} | x = x^{*})</annotation></semantics></math>,
is ~2.92, which we obtain using <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu</span></span>
<span><span class="co">#&gt;        1 </span></span>
<span><span class="co">#&gt; 2.919094</span></span></code></pre></div>
<p>This value is the <em>mean</em> of a Gaussian distribution that, if
our model is a correct description of the data, describes the
distribution of the values that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Y</mi><annotation encoding="application/x-tex">Y</annotation></semantics></math>
might take when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">x = 0.5</annotation></semantics></math>.
The Gaussian distribution is defined by two parameters; the mean,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Î¼</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>,
which describes the middle of the distribution, and the variance,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>Ïƒ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math>,
which describes how spread out the distribution is about the mean. To
fully describe the Gaussian distribution of the response when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">x = 0.5</annotation></semantics></math>,
we need an estimate of the variance. We didnâ€™t model this explicitly in
the our GAM, but we get an estimate any from the modelâ€™s scale
parameter,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Ï•</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>.
This is stored as the element <code>scale</code> in the model object</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">$</span><span class="va">scale</span></span>
<span><span class="va">sigma</span></span>
<span><span class="co">#&gt; [1] 1.019426</span></span></code></pre></div>
<p>We can visualise what this distribution looks like with some magic
from the <em>ggdist</em> package</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ydist <span class="op">=</span> <span class="fu">dist_normal</span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mu</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0.5</span>, scale <span class="op">=</span> <span class="fl">0.2</span>, slab_fill <span class="op">=</span> <span class="st">"#E69F00"</span>, slab_alpha <span class="op">=</span> <span class="fl">0.7</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">gw_f2</span>, colour <span class="op">=</span> <span class="st">"#0072B2"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0.5</span>, y <span class="op">=</span> <span class="va">mu</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>The orange region shows the expected density of response values at
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo>*</mo></msup><mo>=</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">x^{\ast} = 0.5</annotation></semantics></math>
that our model predicts we could expect to observe. This region assumes
there is no uncertainty in the estimate of the mean of variance.
Prediction intervals take into account the variation about the expected
value, plus the uncertainty in the expected value.
<code><a href="../reference/fitted_values.html">fitted_values()</a></code> conveniently returns this uncertainty for
us, which by default is a 95% credible interval</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fitted_values.html">fitted_values</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 Ã— 6</span></span></span>
<span><span class="co">#&gt;    .row     x .fitted   .se .lower_ci .upper_ci</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1   0.5    2.92 0.161      2.60      3.23</span></span></code></pre></div>
<p>The <code>.se</code> column is the standard error (standard
deviation) of the estimated value (<code>.fitted</code>), while
<code>.lower_ci</code> and <code>.upper_ci</code> are lower and upper
uncertainty bounds (at the 95% level) on the estimated value
respectively. With GAMs fitted through mgcv we donâ€™t have a
corresponding estimate of the uncertainty in the scale parameter,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Ï•</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>,
which for this model is the estimated standard deviation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>Ïƒ</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{\sigma}</annotation></semantics></math>.</p>
<p>While it would be pretty easy to compute upper and lower tail
quantiles of the fitted Gaussian distribution for a range of values of
<code>x</code> to get a prediction interval, weâ€™d be ignoring the
uncertainty in the model estimates of the mean. Posterior simulation
provides a simple and convenient way to generate a prediction interval
that includes the model uncertainty, and which works in principle for
any of the families available in mgcv (although in practice, not all
families are currently supported by gratia).</p>
<p>To compute a prediction interval over <code>x</code> for our GAM, we
being by creating a set of data evenly over the range of <code>x</code>
observed in the data used to fit the model</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_slice.html">data_slice</a></span><span class="op">(</span><span class="va">m</span>, x <span class="op">=</span> <span class="fu"><a href="../reference/evenly.html">evenly</a></span><span class="op">(</span><span class="va">x</span>, n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>.row <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The added variable <code>.row</code> will be used later to match
posterior simulated values to the row in the prediction data set
<code>ds</code>. We also compute the fitted values for these new
observations using <code><a href="../reference/fitted_values.html">fitted_values()</a></code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitted_values.html">fitted_values</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">ds</span><span class="op">)</span></span></code></pre></div>
<p>That step isnâ€™t required in order to do posterior simulation with
gratia, but weâ€™ll use the fitted values later to show the model
estimated values and their uncertainty in contrast to the prediction
interval.</p>
<p>We use <code><a href="../reference/posterior_samples.html">posterior_samples()</a></code> to generate new response data
for each of the new <code>x</code> values in <code>ds</code> and use a
join to add the prediction data to each draw</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_samples.html">posterior_samples</a></span><span class="op">(</span><span class="va">m</span>, n <span class="op">=</span> <span class="fl">10000</span>, data <span class="op">=</span> <span class="va">ds</span>, seed <span class="op">=</span> <span class="fl">24</span>,</span>
<span>  unconditional <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ds</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.row</span> <span class="op">==</span> <span class="va">.row</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ps</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2,000,000 Ã— 4</span></span></span>
<span><span class="co">#&gt;     .row .draw .response       x</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1     1   -<span style="color: #BB0000;">1.34</span>   0.001<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2     1   -<span style="color: #BB0000;">0.049</span><span style="color: #BB0000; text-decoration: underline;">5</span> 0.006<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3     1    0.030<span style="text-decoration: underline;">8</span> 0.011<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4     1   -<span style="color: #BB0000;">0.783</span>  0.016<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5     1    0.861  0.021<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6     1    0.475  0.026<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7     1    0.858  0.031<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8     1    0.143  0.036<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9     1   -<span style="color: #BB0000;">0.034</span><span style="color: #BB0000; text-decoration: underline;">4</span> 0.041<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10     1    1.04   0.046<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 1,999,990 more rows</span></span></span></code></pre></div>
<p>Here we asked for 10000 posterior draws for each new value of
<code>x</code>. Ideally weâ€™d generate at least three or four times this
many draws to get a more precise estimate of the prediction interval,
but we keep the number low in this vignette to avoid excessive
computation time. Weâ€™re also using the smoothness parameter selection
corrected version of the Bayesian covariance matrix; this matrix has
been adjusted to account for us not knowing the value of the smoothing
parameter for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">f(x_i)</annotation></semantics></math>.</p>
<p><code>ps</code> is a tibble, with <code>n * nrow(ds)</code> rows. The
<code>.draw</code> variable groups the simulated values by posterior
draw, while <code>.row</code> groups posterior draws for the same value
of <code>x</code>. To summarise the posterior draws using {dplyr} we
need a function that will compute quantiles of the posterior
distribution for each value of <code>x</code> (each <code>.row</code>).
The following function is a simple wrapper around the
<code><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile()</a></code> function from base R, which arranges the output
from <code><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile()</a></code> as a data frame.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quantile_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">probs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>    .value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, probs <span class="op">=</span> <span class="va">probs</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>    .q <span class="op">=</span> <span class="va">probs</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We apply this function to our set of posterior draws, grouping by
<code>.row</code> to summarise separately the posterior distribution for
each new value of <code>x</code>. <code><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe()</a></code> is used to
summarise the posterior using our <code>quantile_fun()</code> function.
For ease of use, we pivot the resulting summary from long to wide format
and add on the covariate values by joining on the <code>.row</code>
variable</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_int</span> <span class="op">&lt;-</span> <span class="va">ps</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.row</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span><span class="fu">quantile_fun</span><span class="op">(</span><span class="va">.response</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span></span>
<span>    id_cols <span class="op">=</span> <span class="va">.row</span>, names_from <span class="op">=</span> <span class="va">.q</span>, values_from <span class="op">=</span> <span class="va">.value</span>,</span>
<span>    names_prefix <span class="op">=</span> <span class="st">".q"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ds</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.row</span> <span class="op">==</span> <span class="va">.row</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_int</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 200 Ã— 5</span></span></span>
<span><span class="co">#&gt;     .row  .q2.5    .q50 .q97.5       x</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 -<span style="color: #BB0000;">2.84</span>  -<span style="color: #BB0000;">0.847</span>    1.25 0.001<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 -<span style="color: #BB0000;">2.70</span>  -<span style="color: #BB0000;">0.651</span>    1.41 0.006<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 -<span style="color: #BB0000;">2.50</span>  -<span style="color: #BB0000;">0.434</span>    1.62 0.011<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 -<span style="color: #BB0000;">2.24</span>  -<span style="color: #BB0000;">0.207</span>    1.83 0.016<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 -<span style="color: #BB0000;">2.04</span>  -<span style="color: #BB0000;">0.019</span><span style="color: #BB0000; text-decoration: underline;">7</span>   2.01 0.021<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 -<span style="color: #BB0000;">1.81</span>   0.191    2.25 0.026<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 -<span style="color: #BB0000;">1.59</span>   0.391    2.41 0.031<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 -<span style="color: #BB0000;">1.38</span>   0.594    2.60 0.036<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 -<span style="color: #BB0000;">1.20</span>   0.831    2.84 0.041<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 -<span style="color: #BB0000;">0.935</span>  1.06     3.04 0.046<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># â„¹ 190 more rows</span></span></span></code></pre></div>
<p>The 95% prediction interval is shown for the first 10 rows of the
prediction data. the column labelled <code>.q50</code> is the median of
the posterior distribution.</p>
<p>We can now use the various objects we have produced to plot the
fitted values from the model (and their uncertainties), as well as the
prediction intervals we just generated. We add the observed data used to
fit the model as black points, and summarise the posterior samples (from
<code>ps</code>) using a hexagonal binning (to avoid plotting all 2
million posterior samples)</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fv</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">.fitted</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># summarise the posterior samples</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">ps</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">.response</span>, fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, alpha <span class="op">=</span> <span class="fl">0.7</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add the lower and upper prediction intervals</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">p_int</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.q2.5</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#56B4E9"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">p_int</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.q97.5</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#56B4E9"</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add the lower and upper credible intervals</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.lower_ci</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#56B4E9"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.upper_ci</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#56B4E9"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add the fitted model</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add the observed data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Response"</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/plot-prediction-intervals-gaussian-gam-1.png" width="700"></p>
<p>The outermost pair of blue lines on the plot above is the prediction
interval we created. This interval encloses, as expected, almost all of
the observe data points. It also encloses, by design, most of the
posterior samples, as indicated by the filled hexagonal bins, with
warmer colours indicating larger counts of posterior draws.</p>
</div>
<div class="section level3">
<h3 id="metropolis-hastings-sampler">Metropolis Hastings sampler<a class="anchor" aria-label="anchor" href="#metropolis-hastings-sampler"></a>
</h3>
<p>In some cases, the Gaussian approximation to the posterior
distribution of the model coefficients can fail. Simon Wood shows an
example of just such a failure in the <code><a href="https://rdrr.io/pkg/mgcv/man/gam.mh.html" class="external-link">?gam.mh</a></code> help page,
where the Gaussian approximation is basically useless for a binomial GAM
with large numbers of zeroes. <code><a href="https://rdrr.io/pkg/mgcv/man/gam.mh.html" class="external-link">mgcv::gam.mh()</a></code> implements a
simple Metropolis Hastings sampler, which alternates proposals from a
Gaussian or <em>t</em> distribution approximation to the posterior with
random walk proposals that are based on the shrunken approximate
posterior covariance matrix.</p>
<p>In this section, I rework Simonâ€™s example of the failure of the
Gaussian approximation from <code><a href="https://rdrr.io/pkg/mgcv/man/gam.mh.html" class="external-link">?gam.mh</a></code> to show how to use
<em>gratia</em> to generate posterior draws using the Metropolis
Hastings sampler provided by <code><a href="https://rdrr.io/pkg/mgcv/man/gam.mh.html" class="external-link">gam.mh()</a></code>.</p>
<p>We begin by defining a function that will simulate data for the
example.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ga_fail</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">seed</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">89</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">13</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>    <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">46</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>      x <span class="op">=</span> <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/with_seed.html" class="external-link">with_seed</a></span><span class="op">(</span></span>
<span>        <span class="va">seed</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">10</span> <span class="op">*</span> <span class="fl">5</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">-</span> <span class="fl">11</span><span class="op">)</span> <span class="op">*</span> <span class="fl">20</span> <span class="op">+</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      .row <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">.row</span>, .before <span class="op">=</span> <span class="fl">1L</span><span class="op">)</span></span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Which we use to simulate a data set and plot it</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">ga_fail</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/plot-ga-fail-data-1.png" width="700"></p>
<p>Note how there are very few zeroes and that for large parts of the
covariate space the response is all zeroes.</p>
<p>We fit a binomial (logistic) GAM to the data</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m_logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df</span>, method <span class="op">=</span> <span class="st">"REML"</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></code></pre></div>
<p>and then generate sample from the posterior distribution using the
default Gaussian approximation and subsequently using the simpler
Metropolis Hastings sampler.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fs_ga</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitted_samples.html">fitted_samples</a></span><span class="op">(</span><span class="va">m_logit</span>, n <span class="op">=</span> <span class="fl">2000</span>, seed <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">fs_mh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitted_samples.html">fitted_samples</a></span><span class="op">(</span><span class="va">m_logit</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">2000</span>, seed <span class="op">=</span> <span class="fl">2</span>, method <span class="op">=</span> <span class="st">"mh"</span>, thin <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  rw_scale <span class="op">=</span> <span class="fl">0.4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code>method</code> argument is used to select the Metropolis
Hastings sampler, and we specify two additional arguments:</p>
<ol style="list-style-type: decimal">
<li>
<code>thin</code>, which controls how many draws are skipped between
each retained sample, and</li>
<li>
<code>rw_scale</code>, which is the scaling factor by which the
posterior covariance matrix is shrunk for the random walk
proposals.</li>
</ol>
<p>We leave the two other important arguments at their defaults:</p>
<ol style="list-style-type: decimal">
<li>
<code>burnin = 1000</code>, the number of samples to discard prior
to sampling, and</li>
<li>
<code>t_df = 40</code>, the degrees of freedom for the <em>t</em>
proposals.</li>
</ol>
<p>Because the the degrees of freedom for the <em>t</em> proposals is
large, weâ€™re effectively doing Gaussian approximation with this default,
alternating those proposals with random walk proposals.</p>
<p>Having collected the posterior draws, we summarise each set into 50%,
80%, and 95% intervals using <code><a href="http://mjskay.github.io/ggdist/reference/point_interval.html" class="external-link">ggdist::median_qi()</a></code>, and add
on the data locations with a left join</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">excl_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">".draw"</span>, <span class="st">".parameter"</span>, <span class="st">".row"</span><span class="op">)</span></span>
<span><span class="va">int_ga</span> <span class="op">&lt;-</span> <span class="va">fs_ga</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.row</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">median_qi</span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span>, .exclude <span class="op">=</span> <span class="va">excl_col</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">df</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.row</span> <span class="op">==</span> <span class="va">.row</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">int_mh</span> <span class="op">&lt;-</span> <span class="va">fs_mh</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.row</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">median_qi</span><span class="op">(</span>.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.95</span><span class="op">)</span>, .exclude <span class="op">=</span> <span class="va">excl_col</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">df</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.row</span> <span class="op">==</span> <span class="va">.row</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>First we plot the intervals for the Gaussian approximation to the
posterior, and then we repeat the plot using the intervals derived from
the Metropolis Hastings sampler, arranging the two plots using
<em>patchwork</em></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plt_ga</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_lineribbon</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">int_ga</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">.fitted</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Gaussian approximation"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt_mh</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_lineribbon</span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">int_mh</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">.fitted</span>, ymin <span class="op">=</span> <span class="va">.lower</span>, ymax <span class="op">=</span> <span class="va">.upper</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_brewer</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Metropolis Hastings sampler"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plt_ga</span> <span class="op">+</span> <span class="va">plt_mh</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/ga-fail-plot-plus-intervals-1.png" width="700"></p>
<p>The Gaussian approximation-based intervals are shown on the left of
the figure, which for most of the range of <code>x</code> are largely
useless, covering the entire range of the response, despite the fact
that we only observed zeroes for large parts of the covariate space.
Contrast those intervals with the ones obtained using the Metropolis
Hastings sampler; these intervals much better reflect the uncertainty in
the estimated response as a function of <code>x</code> where the data
are all zeroes.</p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-Luo1997-xg" class="csl-entry">
Luo, Z., &amp; Wahba, G. (1997). Hybrid adaptive splines. <em>Journal of
the American Statistical Association</em>, <em>92</em>(437), 107â€“116.
</div>
<div id="ref-Marra2012-bq" class="csl-entry">
Marra, G., &amp; Wood, S. N. (2012). Coverage properties of confidence
intervals for generalized additive model components. <em>Scandinavian
Journal of Statistics, Theory and Applications</em>, <em>39</em>(1),
53â€“74.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://fromthebottomoftheheap.net" class="external-link">Gavin L. Simpson</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
