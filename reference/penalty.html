<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Extract and tidy penalty matrices — penalty • gratia</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet"><meta property="og:title" content="Extract and tidy penalty matrices — penalty"><meta name="description" content="Extract and tidy penalty matrices"><meta property="og:description" content="Extract and tidy penalty matrices"><meta property="og:image" content="https://gavinsimpson.github.io/gratia/reference/figures/README-draw-gam-figure-1.png"><meta property="og:image:alt" content="Plot produced by draw() of 4 smooth functions from a fitted generalized additive model"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:creator" content="@ucfagls"><meta name="twitter:site" content="@ucfagls"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gratia</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.10.0.9016</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/gratia.html">Get started</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/custom-plotting.html">Customizing plots</a></li>
    <li><a class="dropdown-item" href="../articles/data-slices.html">Data slices</a></li>
    <li><a class="dropdown-item" href="../articles/posterior-simulation.html">Posterior Simulation</a></li>
  </ul></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gavinsimpson/gratia/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Extract and tidy penalty matrices</h1>
      <small class="dont-index">Source: <a href="https://github.com/gavinsimpson/gratia/blob/main/R/penalty.R" class="external-link"><code>R/penalty.R</code></a></small>
      <div class="d-none name"><code>penalty.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Extract and tidy penalty matrices</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">penalty</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Default S3 method</span></span>
<span><span class="fu">penalty</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  rescale <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">data</span>,</span>
<span>  knots <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  constraints <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  diagonalize <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'gam'</span></span>
<span><span class="fu">penalty</span><span class="op">(</span></span>
<span>  <span class="va">object</span>,</span>
<span>  select <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  smooth <span class="op">=</span> <span class="fu">deprecated</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  rescale <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  partial_match <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'mgcv.smooth'</span></span>
<span><span class="fu">penalty</span><span class="op">(</span><span class="va">object</span>, rescale <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'tensor.smooth'</span></span>
<span><span class="fu">penalty</span><span class="op">(</span><span class="va">object</span>, margins <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 't2.smooth'</span></span>
<span><span class="fu">penalty</span><span class="op">(</span><span class="va">object</span>, margins <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 're.smooth.spec'</span></span>
<span><span class="fu">penalty</span><span class="op">(</span><span class="va">object</span>, <span class="va">data</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>a fitted GAM or a smooth.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>additional arguments passed to methods.</p></dd>


<dt id="arg-rescale">rescale<a class="anchor" aria-label="anchor" href="#arg-rescale"></a></dt>
<dd><p>logical; by default, <em>mgcv</em> will scale the penalty matrix for
better performance in <code><a href="https://rdrr.io/pkg/mgcv/man/gamm.html" class="external-link">mgcv::gamm()</a></code>. If <code>rescale</code> is <code>TRUE</code>, this scaling
will be undone to put the penalty matrix back on the original scale.</p></dd>


<dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>data frame; a data frame of values for terms mentioned in the
smooth specification.</p></dd>


<dt id="arg-knots">knots<a class="anchor" aria-label="anchor" href="#arg-knots"></a></dt>
<dd><p>a list or data frame with named components containing
knots locations. Names must match the covariates for which the basis
is required. See <code><a href="https://rdrr.io/pkg/mgcv/man/smoothCon.html" class="external-link">mgcv::smoothCon()</a></code>.</p></dd>


<dt id="arg-constraints">constraints<a class="anchor" aria-label="anchor" href="#arg-constraints"></a></dt>
<dd><p>logical; should identifiability constraints be applied to
the smooth basis. See argument <code>absorb.cons</code> in <code><a href="https://rdrr.io/pkg/mgcv/man/smoothCon.html" class="external-link">mgcv::smoothCon()</a></code>.</p></dd>


<dt id="arg-diagonalize">diagonalize<a class="anchor" aria-label="anchor" href="#arg-diagonalize"></a></dt>
<dd><p>logical; if <code>TRUE</code>, reparameterises the smooth such that
the associated penalty is an identity matrix. This has the effect of
turning the last diagonal elements of the penalty to zero, which highlights
the penalty null space.</p></dd>


<dt id="arg-select">select<a class="anchor" aria-label="anchor" href="#arg-select"></a></dt>
<dd><p>character, logical, or numeric; which smooths to extract
penalties for. If <code>NULL</code>, the default, then penalties for all model
smooths are drawn. Numeric <code>select</code> indexes the smooths in the order they
are specified in the formula and stored in <code>object</code>. Character <code>select</code>
matches the labels for smooths as shown for example in the output from
<code>summary(object)</code>. Logical <code>select</code> operates as per numeric <code>select</code> in
the order that smooths are stored.</p></dd>


<dt id="arg-smooth">smooth<a class="anchor" aria-label="anchor" href="#arg-smooth"></a></dt>
<dd><p><a href="https://lifecycle.r-lib.org/articles/stages.html#deprecated" class="external-link"><img src="figures/lifecycle-deprecated.svg" alt="[Deprecated]"></a> Use <code>select</code> instead.</p></dd>


<dt id="arg-partial-match">partial_match<a class="anchor" aria-label="anchor" href="#arg-partial-match"></a></dt>
<dd><p>logical; should smooths be selected by partial matches
with <code>select</code>? If <code>TRUE</code>, <code>select</code> can only be a single string to match
against.</p></dd>


<dt id="arg-margins">margins<a class="anchor" aria-label="anchor" href="#arg-margins"></a></dt>
<dd><p>logical; extract the penalty matrices for the tensor
product or the marginal smooths of the tensor product?</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A 'tibble' (data frame) of class <code>penalty_df</code> inheriting from
<code>tbl_df</code>, with the following components:</p><ul><li><p><code>.smooth</code> - character; the label <em>mgcv</em> uses to refer to the smooth,</p></li>
<li><p><code>.type</code> - character; the type of smooth,</p></li>
<li><p><code>.penalty</code> - character; the label for the specific penalty. Some smooths
have multiple penalty matrices, so the <code>penalty</code> component identifies the
particular penalty matrix and uses the labelling that <em>mgcv</em> uses
internally,</p></li>
<li><p><code>.row</code> - character; a label of the form <code>fn</code> where <code>n</code> is an integer for
the <code>n</code>th basis function, referencing the columns of the penalty matrix,</p></li>
<li><p><code>.col</code> - character; a label of the form <code>fn</code> where <code>n</code> is an integer for
the <code>n</code>th basis function, referencing the columns of the penalty matrix,</p></li>
<li><p><code>.value</code> - double; the value of the penalty matrix for the combination of
<code>row</code> and <code>col</code>,</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>The <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> method uses <code><a href="https://rdrr.io/r/base/zapsmall.html" class="external-link">base::zapsmall()</a></code> to turn very small numbers
into 0s for display purposes only; the underlying values of the penalty
matrix or matrices are not changed.</p>
<p>For smooths that are subject to an eigendecomposition (e.g. the default
thin plate regression splines, <code>bs = "tp"</code>), the signs of the eigenvectors
are not defined and as such you can expect differences across systems in
the penalties for such smooths that are system-, OS-, and CPU architecture-
specific.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Gavin L. Simpson</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu"><a href="load_mgcv.html">load_mgcv</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="data_sim.html">data_sim</a></span><span class="op">(</span><span class="st">"eg4"</span>, n <span class="op">=</span> <span class="fl">400</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu">gam</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">y</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">x0</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">x1</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>    <span class="fu">s</span><span class="op">(</span><span class="va">x2</span>, by <span class="op">=</span> <span class="va">fac</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  data <span class="op">=</span> <span class="va">dat</span>, method <span class="op">=</span> <span class="st">"REML"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># penalties for all smooths</span></span></span>
<span class="r-in"><span><span class="fu">penalty</span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 405 x 6</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    .smooth .type .penalty .row  .col   .value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 1</span> s(x0)   CRS   s(x0)    F1    F1     0.783 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 2</span> s(x0)   CRS   s(x0)    F1    F2    -<span style="color: #BB0000;">0.635</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 3</span> s(x0)   CRS   s(x0)    F1    F3     0.265 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 4</span> s(x0)   CRS   s(x0)    F1    F4    -<span style="color: #BB0000;">0.020</span><span style="color: #BB0000; text-decoration: underline;">3</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 5</span> s(x0)   CRS   s(x0)    F1    F5     0.044<span style="text-decoration: underline;">1</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 6</span> s(x0)   CRS   s(x0)    F1    F6     0.037<span style="text-decoration: underline;">8</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 7</span> s(x0)   CRS   s(x0)    F1    F7     0.048<span style="text-decoration: underline;">2</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 8</span> s(x0)   CRS   s(x0)    F1    F8     0.021<span style="text-decoration: underline;">6</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 9</span> s(x0)   CRS   s(x0)    F1    F9     0.024<span style="text-decoration: underline;">7</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">10</span> s(x0)   CRS   s(x0)    F2    F1    -<span style="color: #BB0000;">0.635</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># i 395 more rows</span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># for a specific smooth</span></span></span>
<span class="r-in"><span><span class="fu">penalty</span><span class="op">(</span><span class="va">m</span>, select <span class="op">=</span> <span class="st">"s(x2):fac1"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 81 x 6</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    .smooth    .type .penalty   .row  .col   .value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 1</span> s(x2):fac1 CRS   s(x2):fac1 F1    F1     1.66  </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 2</span> s(x2):fac1 CRS   s(x2):fac1 F1    F2    -<span style="color: #BB0000;">0.755</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 3</span> s(x2):fac1 CRS   s(x2):fac1 F1    F3     0.430 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 4</span> s(x2):fac1 CRS   s(x2):fac1 F1    F4     0.084<span style="text-decoration: underline;">6</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 5</span> s(x2):fac1 CRS   s(x2):fac1 F1    F5     0.192 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 6</span> s(x2):fac1 CRS   s(x2):fac1 F1    F6     0.152 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 7</span> s(x2):fac1 CRS   s(x2):fac1 F1    F7     0.188 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 8</span> s(x2):fac1 CRS   s(x2):fac1 F1    F8     0.164 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;"> 9</span> s(x2):fac1 CRS   s(x2):fac1 F1    F9     0.059<span style="text-decoration: underline;">7</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">10</span> s(x2):fac1 CRS   s(x2):fac1 F2    F1    -<span style="color: #BB0000;">0.755</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># i 71 more rows</span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://fromthebottomoftheheap.net" class="external-link">Gavin L. Simpson</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

