<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gratia">
<title>Posterior Simulation • gratia</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Posterior Simulation">
<meta property="og:description" content="gratia">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gratia</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.9.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/gratia.html">Get started</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/custom-plotting.html">Customizing plots</a>
    <a class="dropdown-item" href="../articles/data-slices.html">Data slices</a>
    <a class="dropdown-item" href="../articles/posterior-simulation.html">Posterior Simulation</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/gavinsimpson/gratia/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Posterior Simulation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/gavinsimpson/gratia/blob/HEAD/vignettes/posterior-simulation.Rmd" class="external-link"><code>vignettes/posterior-simulation.Rmd</code></a></small>
      <div class="d-none name"><code>posterior-simulation.Rmd</code></div>
    </div>

    
    
<p><introduction></introduction></p>
<p>This vignette describes {gratia}’s tools for posterior simulation, a
powerful way of doing inference using estimated generalized additive
models.</p>
<p>We’ll need the following packages for this vignette:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mgcv"</span>, <span class="st">"gratia"</span>, <span class="st">"dplyr"</span>, <span class="st">"tidyr"</span>, <span class="st">"ggplot2"</span>, <span class="st">"ggdist"</span>, <span class="st">"distributional"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">pkgs</span>, <span class="va">library</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span>, logical.return <span class="op">=</span> <span class="cn">TRUE</span>, character.only <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: nlme</span></span>
<span><span class="co">#&gt; This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:nlme':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     collapse</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="co">#&gt;           mgcv         gratia          dplyr          tidyr        ggplot2 </span></span>
<span><span class="co">#&gt;           TRUE           TRUE           TRUE           TRUE           TRUE </span></span>
<span><span class="co">#&gt;         ggdist distributional </span></span>
<span><span class="co">#&gt;           TRUE           TRUE</span></span></code></pre></div>
<p>A generalized additive model (GAM) has the following form</p>
<p><span class="math display">\[
g(\mu_i) = \eta_i = A_i + \mathbf{X}_i \boldsymbol{\gamma} +
\sum_{j=1}^{J} f_j(x_{ij}), \; y_i \sim EF(\mu_i, \phi)
\]</span></p>
<p>where <span class="math inline">\(g()\)</span> is the link function,
<span class="math inline">\(A\)</span> is an offset, <span class="math inline">\(\mathbf{X}_i\)</span> is the <span class="math inline">\(i\)</span>th row of a parametric model matrix,
<span class="math inline">\(\boldsymbol{\gamma}\)</span> is a vector of
parameters for the parametric terms, <span class="math inline">\(f_j\)</span> is a smooth function of covariate
<span class="math inline">\(x_j\)</span>. <span class="math inline">\(y_i \sim EF(\mu_i, \phi)\)</span> denotes that the
observations <span class="math inline">\(y_i\)</span> are distributed as
some member of the exponential family of distributions with mean <span class="math inline">\(\mu_i\)</span> and scale parameter <span class="math inline">\(\phi\)</span>.</p>
<p>The smooth functions <span class="math inline">\(f_j\)</span> are
represented in the model via penalised splines basis expansions of the
covariates, that are a weighted sum of basis functions</p>
<p><span class="math display">\[
f_j(x_{ij}) = \sum_{k=1}^{K} \beta_{jk} b_{jk}(x_{ij})
\]</span></p>
<p>where <span class="math inline">\(\beta_{jk}\)</span> is the weight
(coefficient) associated with the <span class="math inline">\(k\)</span>th basis function <span class="math inline">\(b_{jk}()\)</span> evaluated at the covariate value
<span class="math inline">\(x_{ij}\)</span> for the <span class="math inline">\(j\)</span>th smooth function <span class="math inline">\(f_j\)</span>. Wiggliness penalties <span class="math inline">\(\sum_j \lambda_j \boldsymbol{\beta}^{\mathsf{T}}
\mathbf{S}_j \boldsymbol{\beta}\)</span> controls the degree of
smoothing applied to the <span class="math inline">\(f_j\)</span>
through the smoothing parameters <span class="math inline">\(\lambda_j\)</span>.</p>
<p>Having fitted the GAM in mgcv using REML or ML smoothness selection
we obtain a vector of coefficients <span class="math inline">\(\hat{\boldsymbol{\beta}}\)</span> (which also
includes the coefficients for the parametric terms, , for convenience).
The estimates of these coefficients are conditional upon the data and
the selected values of the smoothing parameters <span class="math inline">\(\lambda_j\)</span>. Using the Bayesian view of
smoothing via REML smoothness selection, <span class="math inline">\(\boldsymbol{\beta}\)</span> has a multivariate
normal posterior distribution <span class="math inline">\(\boldsymbol{\beta} | \boldsymbol{\eta},
\boldsymbol{\lambda} \sim \text{MVN}(\hat{\boldsymbol{\beta}},
\mathbf{V}_{\text{b}})\)</span>, where <span class="math inline">\(\mathbf{V}_{\text{b}}\)</span> is the Bayesian
covariance matrix of the estimated parameters, (the subscript <span class="math inline">\(\text{b}\)</span> is used to differentiate this
Bayesian covariance matrix from the frequentist version which is also
available in the mgcv model output).</p>
<div class="section level2">
<h2 id="what-are-we-simulating">What are we simulating?<a class="anchor" aria-label="anchor" href="#what-are-we-simulating"></a>
</h2>
<p>Posterior simulation involves randomly sampling from <span class="math inline">\(\text{MVN}(\hat{\boldsymbol{\beta}},
\mathbf{V}_{\text{b}})\)</span> or <span class="math inline">\(EF(\mu_i,
\phi)\)</span>, or both.</p>
<p>We might simulate from the posterior distribution of a single
estimated smooth function to see the uncertainty in the estimate of that
function. To do this we simulate for just a subset of <span class="math inline">\(\beta_{j \cdot}\)</span> associated with the <span class="math inline">\(f_j\)</span> of interest. Instead, we might be
interested in the uncertainty in the expectation (expected value) of the
model at some given values of the covariates, in which case we can
simulate for all <span class="math inline">\(\boldsymbol{\beta}\)</span>
to sample from the posterior of <span class="math inline">\(\mathbb{E}(y_i)\)</span>, the fitted values of the
model. Or we might want to generate new values of response variable via
draws from the conditional distribution of the response, by simulating
new response data <span class="math inline">\(\mathbb{y}^{\ast}\)</span>, at either the observed
<span class="math inline">\(\mathbf{x}\)</span> or new values $^{}, from
<span class="math inline">\(y^{\ast}_i | \boldsymbol{\eta}, \mathbf{x}
\sim EF(\hat{\mu_i}, \phi)\)</span>. Finally, we can combine posterior
simulation from both distributions to generate posterior draws for new
data <span class="math inline">\(\mathbb{y}^{\ast}\)</span> that also
include the uncertainty in the expected values.</p>
<p>gratia has functionality for all these options through the following
functions</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="../reference/smooth_samples.html">smooth_samples()</a></code> generates draws from the posterior
distribution of single estimated smooth functions,</li>
<li>
<code><a href="../reference/fitted_samples.html">fitted_samples()</a></code> generates draws from the posterior
distribution of <span class="math inline">\(\mathbb{E}(y_i |
\mathbf{X}_i = x_i)\)</span>, the expected value of the responss,</li>
<li>
<code><a href="../reference/predicted_samples.html">predicted_samples()</a></code>, generates new response data given
supplied values of covariates <span class="math inline">\(y^{\ast}_i |
\mathbf{X}_i = x^{\ast}_i\)</span>
</li>
<li>
<code><a href="../reference/posterior_samples.html">posterior_samples()</a></code>, generates draws from the posterior
distribution of the model, including the uncertainty in the estimated
parameters of that model.</li>
</ol>
<p>In simpler terms, <code><a href="../reference/fitted_samples.html">fitted_samples()</a></code> generates predictions
about the “average” or expected value of the response at values of the
covariates. These predictions only include the uncertainty in the
estimated values of the model coefficients. In contrast,
<code><a href="../reference/posterior_samples.html">posterior_samples()</a></code> generates predictions of the actual
values of the response we might expect to observe (if the model is
correct) given values of the covariates. These predicted values include
the variance of the sampling distribution (error term).
<code><a href="../reference/predicted_samples.html">predicted_samples()</a></code> lies somewhere in between these two;
the predicted values only include the variation in the sampling
distribution, and take the model as fixed, known.</p>
<p>It is worth reminding ourselves that these posterior draws are all
conditional upon the selected values of the smoothing parameter(s) <span class="math inline">\(\lambda_j\)</span>. We act as if the wiggliness of
the estimated smooths was known, when in actual fact we estimated
(selected is perhaps a better description) these wiglinesses from the
data during model fitting. If the estimated GAM has been fitted with
<code>method</code> argument <code>"REML"</code>, or <code>"ML"</code>,
then a version of <span class="math inline">\(\mathbf{V}_{\text{b}}\)</span> that is corrected
for having selected smoothing parameters, <span class="math inline">\(\mathbf{V}_{\text{c}}\)</span>, is generally
available. This allows, to an extent, for posterior simulation to
account for the additional source of uncertainty of having chosen then
values of <span class="math inline">\(\boldsymbol{\lambda}\)</span>.</p>
<p>There are two additional functions available in gratia that do
posterior simulation:</p>
<ul>
<li>
<code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code>, and</li>
<li>
<code><a href="../reference/derivative_samples.html">derivative_samples()</a></code>.</li>
</ul>
<p>gratia provides <code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code> methods for models estimated
using <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam()</a></code>, <code><a href="https://rdrr.io/pkg/mgcv/man/bam.html" class="external-link">bam()</a></code>, and <code><a href="https://rdrr.io/pkg/mgcv/man/gamm.html" class="external-link">gamm()</a></code>,
as well as those fitted via <code>scam()</code> in the scam package.
<code><a href="https://rdrr.io/r/stats/simulate.html" class="external-link">simulate()</a></code> is a base R convention that does the same thing
as <code><a href="../reference/predicted_samples.html">predicted_samples()</a></code>, just in a non-tidy way (that is not
pejorative; it returns the simulated response values as a matrix, which
is arguably more useful if you are doing math or further statistical
computation.) <code><a href="../reference/derivative_samples.html">derivative_samples()</a></code> provides draws from the
posterior distribution of the derivative of response variable for a
small change in a focal covariate value.
<code><a href="../reference/derivative_samples.html">derivative_samples()</a></code> is a less general version of
<code><a href="../reference/fitted_samples.html">fitted_samples()</a></code>; you could achieve the same thing by two
separate calls to <code><a href="../reference/fitted_samples.html">fitted_samples()</a></code>. We’ll reserve
discussion of <code><a href="../reference/derivative_samples.html">derivative_samples()</a></code> to a separate vignette
focused on estimating derivatives from GAMs.</p>
<p>In the following sections we’ll look at each of the four main
posterior simulation functions in turn.</p>
</div>
<div class="section level2">
<h2 id="smooth_samples">
<code>smooth_samples()</code><a class="anchor" aria-label="anchor" href="#smooth_samples"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ss_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_sim.html">data_sim</a></span><span class="op">(</span><span class="st">"eg1"</span>, seed <span class="op">=</span> <span class="fl">21</span><span class="op">)</span></span>
<span><span class="va">m_ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x0</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">ss_df</span>, method <span class="op">=</span> <span class="st">"REML"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s_x0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_smooth.html">get_smooth</a></span><span class="op">(</span><span class="va">m_ss</span>, <span class="st">"s(x0)"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/smooth_coef_indices.html">smooth_coef_indices</a></span><span class="op">(</span><span class="va">s_x0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  2  3  4  5  6  7  8  9 10</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sm_samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_samples.html">smooth_samples</a></span><span class="op">(</span><span class="va">m_ss</span>, term <span class="op">=</span> <span class="st">"s(x0)"</span>, n_vals <span class="op">=</span> <span class="fl">100</span>, n <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sm_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/smooth_estimates.html">smooth_estimates</a></span><span class="op">(</span><span class="va">m_ss</span>, smooth <span class="op">=</span> <span class="st">"s(x0)"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/add_confint.html">add_confint</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sm_est</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_lineribbon</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">.lower_ci</span>, ymax <span class="op">=</span> <span class="va">.upper_ci</span><span class="op">)</span>,</span>
<span>    orientation <span class="op">=</span> <span class="st">"vertical"</span>, fill <span class="op">=</span> <span class="st">"#56B4E9"</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sm_samp</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.value</span>, group <span class="op">=</span> <span class="va">.draw</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">1.25</span>, colour <span class="op">=</span> <span class="st">"#E69F00"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="../reference/smooth_label.html">smooth_label</a></span><span class="op">(</span><span class="va">s_x0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="fitted_samples">
<code>fitted_samples()</code><a class="anchor" aria-label="anchor" href="#fitted_samples"></a>
</h2>
</div>
<div class="section level2">
<h2 id="predicted_samples">
<code>predicted_samples()</code><a class="anchor" aria-label="anchor" href="#predicted_samples"></a>
</h2>
</div>
<div class="section level2">
<h2 id="posterior_samples">
<code>posterior_samples()</code><a class="anchor" aria-label="anchor" href="#posterior_samples"></a>
</h2>
</div>
<div class="section level2">
<h2 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<div class="section level3">
<h3 id="prediction-intervals">Prediction intervals<a class="anchor" aria-label="anchor" href="#prediction-intervals"></a>
</h3>
<p>One use for posterior simulation is to generate <em>prediction</em>
intervals for a fitted model. Prediction intervals include two sources
of uncertainty; that from the estimated model itself, plus the sampling
uncertainty or error that arises from drawing observations from the
conditional distribution of the response.</p>
<p>For example, in a Gaussian GAM, the first source of uncertainty comes
from the uncertainty in the estimates of <span class="math inline">\(\beta_j\)</span>, the model coefficients. This
uncertainty is in the mean or expected value of the response. The second
source of uncertainty stems from the error term, the estimated variance
of the response. These two parameters define the conditional
distribution of <span class="math inline">\(Y_i\)</span>. For any value
of the covariate(s) <span class="math inline">\(\mathbf{X}\)</span>, our
estimated model defines the entire distribution of the response values
we might expect to observe at those covariate values.</p>
<p>To illustrate, we’ll fit a simple GAM with a single smooth function
to data simulate from Gu &amp; Wabha’s function <span class="math inline">\(f_2\)</span> using <code><a href="../reference/data_sim.html">data_sim()</a></code>. We
simulate 400 values from a Gaussian distribution with variance <span class="math inline">\(\sigma^2 = 1\)</span>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_sim.html">data_sim</a></span><span class="op">(</span><span class="st">"gwf2"</span>, n <span class="op">=</span> <span class="fl">400</span>, scale <span class="op">=</span> <span class="fl">1</span>, dist <span class="op">=</span> <span class="st">"normal"</span>, seed <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></code></pre></div>
<p>The simulated data, and the true function from which they were
generated are shown below</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">gw_f2</span>, colour <span class="op">=</span> <span class="st">"#0072B2"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/simulated-data-gaussian-gam-1.png" width="700"></p>
<p>A GAM for these data contains a single smooth function of
<code>x</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">df</span>, method <span class="op">=</span> <span class="st">"REML"</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If we consider a new value of the covariate <code>x</code>, <span class="math inline">\(x^{\ast} = 0.5\)</span>, the expected value of the
response given our model, <span class="math inline">\(\mathbb{E}(y^{*} |
x = x^{*})\)</span>, is ~2.92, which we obtain using
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mu</span></span>
<span><span class="co">#&gt;        1 </span></span>
<span><span class="co">#&gt; 2.919094</span></span></code></pre></div>
<p>This value is the <em>mean</em> of a Gaussian distribution that, if
our model is a correct description of the data, describes the
distribution of the values that <span class="math inline">\(Y\)</span>
might take when <span class="math inline">\(x = 0.5\)</span>. The
Gaussian distribution is defined by two parameters; the mean, <span class="math inline">\(\mu\)</span>, which describes the middle of the
distribution, and the variance, <span class="math inline">\(\sigma^2\)</span>, which describes how spread out
the distribution is about the mean. To fully describe the Gaussian
distribution of the response when <span class="math inline">\(x =
0.5\)</span>, we need an estimate of the variance. We didn’t model this
explicitly in the our GAM, but we get an estimate any from the model’s
scale parameter, <span class="math inline">\(\phi\)</span>. This is
stored as the element <code>scale</code> in the model object</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="va">m</span><span class="op">$</span><span class="va">scale</span></span>
<span><span class="va">sigma</span></span>
<span><span class="co">#&gt; [1] 1.019426</span></span></code></pre></div>
<p>We can visualise what this distribution looks like with some magic
from the <em>ggdist</em> package</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">stat_halfeye</span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ydist <span class="op">=</span> <span class="fu">dist_normal</span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mu</span>, sd <span class="op">=</span> <span class="va">sigma</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    x <span class="op">=</span> <span class="fl">0.5</span>, scale <span class="op">=</span> <span class="fl">0.2</span>, slab_fill <span class="op">=</span> <span class="st">"#E69F00"</span>, slab_alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">geom_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">gw_f2</span>, colour <span class="op">=</span> <span class="st">"#0072B2"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0.5</span>, y <span class="op">=</span> <span class="va">mu</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The orange region shows the expected density of response values at
<span class="math inline">\(x^{\ast} = 0.5\)</span> that our model
predicts we could expect to observe. This region assumes there is no
uncertainty in the estimate of the mean of variance. Prediction
intervals take into account the variation about the expected value, plus
the uncertainty in the expected value. <code><a href="../reference/fitted_values.html">fitted_values()</a></code>
conveniently returns this uncertainty for us, which by default is a 95%
credible interval</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fitted_values.html">fitted_values</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 6</span></span></span>
<span><span class="co">#&gt;    .row     x .fitted   .se .lower_ci .upper_ci</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1   0.5    2.92 0.161      2.60      3.23</span></span></code></pre></div>
<p>The <code>.se</code> column is the standard error (standard
deviation) of the estimated value (<code>.fitted</code>), while
<code>.lower_ci</code> and <code>.upper_ci</code> are lower and upper
uncertainty bounds (at the 95% level) on the estimated value
respectively. With GAMs fitted through mgcv we don’t have a
corresponding estimate of the uncertainty in the scale parameter, <span class="math inline">\(\phi\)</span>, which for this model is the
estimated standard deviation <span class="math inline">\(\hat{\sigma}\)</span>.</p>
<p>While it would be pretty easy to compute upper and lower tail
quantiles of the fitted Gaussian distribution for a range of values of
<code>x</code> to get a prediction interval, we’d be ignoring the
uncertainty in the model estimates of the mean. Posterior simulation
provides a simple and convenient way to generate a prediction interval
that includes the model uncertainty, and which works in principle for
any of the families available in mgcv (although in practice, not all
families are currently supported by gratia).</p>
<p>To compute a prediction interval over <code>x</code> for our GAM, we
being by creating a set of data evenly over the range of <code>x</code>
observed in the data used to fit the model</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_slice.html">data_slice</a></span><span class="op">(</span><span class="va">m</span>, x <span class="op">=</span> <span class="fu"><a href="../reference/evenly.html">evenly</a></span><span class="op">(</span><span class="va">x</span>, n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>.row <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The added variable <code>.row</code> will be used later to match
posterior simulated values to the row in the prediction data set
<code>ds</code>. We also compute the fitted values for these new
observations using <code><a href="../reference/fitted_values.html">fitted_values()</a></code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitted_values.html">fitted_values</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">ds</span><span class="op">)</span></span></code></pre></div>
<p>That step isn’t required in order to do posterior simulation with
gratia, but we’ll use the fitted values later to show the model
estimated values and their uncertainty in contrast to the prediction
interval.</p>
<p>We use <code><a href="../reference/posterior_samples.html">posterior_samples()</a></code> to generate new response data
for each of the new <code>x</code> values in <code>ds</code> and use a
join to add the prediction data to each draw</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_samples.html">posterior_samples</a></span><span class="op">(</span><span class="va">m</span>, n <span class="op">=</span> <span class="fl">10000</span>, data <span class="op">=</span> <span class="va">ds</span>, seed <span class="op">=</span> <span class="fl">24</span>,</span>
<span>  unconditional  <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ds</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.row</span> <span class="op">==</span> <span class="va">.row</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ps</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2,000,000 × 4</span></span></span>
<span><span class="co">#&gt;     .row .draw .response       x</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1     1   -<span style="color: #BB0000;">1.34</span>   0.001<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2     1   -<span style="color: #BB0000;">0.049</span><span style="color: #BB0000; text-decoration: underline;">5</span> 0.006<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3     1    0.030<span style="text-decoration: underline;">8</span> 0.011<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4     1   -<span style="color: #BB0000;">0.783</span>  0.016<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5     1    0.861  0.021<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6     1    0.475  0.026<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7     1    0.858  0.031<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8     1    0.143  0.036<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9     1   -<span style="color: #BB0000;">0.034</span><span style="color: #BB0000; text-decoration: underline;">4</span> 0.041<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10     1    1.04   0.046<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,999,990 more rows</span></span></span></code></pre></div>
<p>Here we asked for 10000 posterior draws for each new value of
<code>x</code>. Ideally we’d generate at least three or four times this
many draws to get a more precise estimate of the prediction interval,
but we keep the number low in this vignette to avoid excessive
computation time. We’re also using the smoothness parameter selection
corrected version of the Bayesian covariance matrix; this matrix has
been adjusted to account for us not knowing the value of the smoothing
parameter for <span class="math inline">\(f(x_i)\)</span>.</p>
<p><code>ps</code> is a tibble, with <code>n * nrow(ds)</code> rows. The
<code>.draw</code> variable groups the simulated values by posterior
draw, while <code>.row</code> groups posterior draws for the same value
of <code>x</code>. To summarise the posterior draws using {dplyr} we
need a function that will compute quantiles of the posterior
distribution for each value of <code>x</code> (each <code>.row</code>).
The following function is a simple wrapper around the
<code><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile()</a></code> function from base R, which arranges the output
from <code><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile()</a></code> as a data frame.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">quantile_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">probs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>.value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, probs <span class="op">=</span> <span class="va">probs</span>, <span class="va">...</span><span class="op">)</span>,</span>
<span>    .q <span class="op">=</span> <span class="va">probs</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We apply this function to our set of posterior draws, grouping by
<code>.row</code> to summarise separately the posterior distribution for
each new value of <code>x</code>. <code><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe()</a></code> is used to
summarise the posterior using our <code>quantile_fun()</code> function.
For ease of use, we pivot the resulting summary from long to wide format
and add on the covariate values by joining on the <code>.row</code>
variable</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_int</span> <span class="op">&lt;-</span> <span class="va">ps</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.row</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/reframe.html" class="external-link">reframe</a></span><span class="op">(</span><span class="fu">quantile_fun</span><span class="op">(</span><span class="va">.response</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_wider</span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">.row</span>, names_from <span class="op">=</span> <span class="va">.q</span>, values_from <span class="op">=</span> <span class="va">.value</span>,</span>
<span>    names_prefix <span class="op">=</span> <span class="st">".q"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">ds</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">.row</span> <span class="op">==</span> <span class="va">.row</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p_int</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 200 × 5</span></span></span>
<span><span class="co">#&gt;     .row  .q2.5    .q50 .q97.5       x</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 -<span style="color: #BB0000;">2.84</span>  -<span style="color: #BB0000;">0.847</span>    1.25 0.001<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     2 -<span style="color: #BB0000;">2.70</span>  -<span style="color: #BB0000;">0.651</span>    1.41 0.006<span style="text-decoration: underline;">29</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 -<span style="color: #BB0000;">2.50</span>  -<span style="color: #BB0000;">0.434</span>    1.62 0.011<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     4 -<span style="color: #BB0000;">2.24</span>  -<span style="color: #BB0000;">0.207</span>    1.83 0.016<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     5 -<span style="color: #BB0000;">2.04</span>  -<span style="color: #BB0000;">0.019</span><span style="color: #BB0000; text-decoration: underline;">7</span>   2.01 0.021<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     6 -<span style="color: #BB0000;">1.81</span>   0.191    2.25 0.026<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     7 -<span style="color: #BB0000;">1.59</span>   0.391    2.41 0.031<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     8 -<span style="color: #BB0000;">1.38</span>   0.594    2.60 0.036<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     9 -<span style="color: #BB0000;">1.20</span>   0.831    2.84 0.041<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    10 -<span style="color: #BB0000;">0.935</span>  1.06     3.04 0.046<span style="text-decoration: underline;">3</span> </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 190 more rows</span></span></span></code></pre></div>
<p>The 95% prediction interval is shown for the first 10 rows of the
prediction data. the column labelled <code>.q50</code> is the median of
the posterior distribution.</p>
<p>We can now use the various objects we have produced to plot the
fitted values from the model (and their uncertainties), as well as the
prediction intervals we just generated. We add the observed data used to
fit the model as black points, and summarise the posterior samples (from
<code>ps</code>) using a hexagonal binning (to avoid plotting all 2
million posterior samples)</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fv</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">.fitted</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># summarise the posterior samples</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_hex.html" class="external-link">geom_hex</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ps</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">.response</span>, fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    bins <span class="op">=</span> <span class="fl">50</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add the lower and upper prediction intervals</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">p_int</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.q2.5</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#56B4E9"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">p_int</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.q97.5</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#56B4E9"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add the lower and upper credible intervals</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.lower_ci</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#56B4E9"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">.upper_ci</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"#56B4E9"</span>, linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add the fitted model</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># add the observed data</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Response"</span><span class="op">)</span></span></code></pre></div>
<p><img src="posterior-simulation_files/figure-html/plot-prediction-intervals-gaussian-gam-1.png" width="700"></p>
<p>The outermost pair of blue lines on the plot above is the prediction
interval we created. This interval encloses, as expected, almost all of
the observe data points. It also encloses, by design, most of the
posterior samples, as indicated by the filled hexagonal bins, with
warmer colours indicating larger counts of posterior draws.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Gavin L. Simpson.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
